<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Medical Chat - Meddy</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fmeddy6709back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.6"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 to-background">
    <!-- Header Navigation -->
    <header class="bg-surface/80 backdrop-blur-sm border-b border-surface-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-primary" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 2C8.268 2 2 8.268 2 16s6.268 14 14 14 14-6.268 14-14S23.732 2 16 2zm0 4c1.105 0 2 .895 2 2s-.895 2-2 2-2-.895-2-2 .895-2 2-2zm4 18h-8v-2h2v-6h-2v-2h6v8h2v2z" fill="currentColor"/>
                            <circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h1 class="text-xl font-semibold text-text-primary">Meddy</h1>
                        <p class="text-xs text-text-secondary">AI Medical Analysis</p>
                    </div>
                </div>

                <!-- Navigation Links -->
                <nav class="hidden md:flex space-x-8">
                    <a href="medical_report_upload.html" class="text-text-secondary hover:text-text-primary transition-colors duration-200 px-3 py-2 rounded-lg hover:bg-surface-700">Upload</a>
                    <a href="report_analysis_summary.html" class="text-text-secondary hover:text-text-primary transition-colors duration-200 px-3 py-2 rounded-lg hover:bg-surface-700">Analysis</a>
                    <a href="ai_medical_chat_interface.html" class="text-primary font-medium px-3 py-2 rounded-lg bg-primary/10">Chat</a>
                </nav>

                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button type="button" class="text-text-secondary hover:text-text-primary p-2 rounded-lg hover:bg-surface-700 transition-colors duration-200" onclick="toggleMobileMenu()">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobile-menu" class="md:hidden hidden border-t border-surface-700 py-4">
                <div class="space-y-2">
                    <a href="medical_report_upload.html" class="block text-text-secondary hover:text-text-primary transition-colors duration-200 px-3 py-2 rounded-lg hover:bg-surface-700">Upload</a>
                    <a href="report_analysis_summary.html" class="block text-text-secondary hover:text-text-primary transition-colors duration-200 px-3 py-2 rounded-lg hover:bg-surface-700">Analysis</a>
                    <a href="ai_medical_chat_interface.html" class="block text-primary font-medium px-3 py-2 rounded-lg bg-primary/10">Chat</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Chat Interface -->
    <div class="flex flex-col h-screen" style="height: calc(100vh - 4rem);">
        <!-- Desktop Layout -->
        <div class="flex flex-1 max-w-7xl mx-auto w-full">
            <!-- Report Summary Sidebar (Desktop) -->
            <div class="hidden lg:block w-80 border-r border-surface-700 bg-surface/30">
                <div class="p-6 h-full overflow-y-auto">
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-text-primary mb-2">Report Summary</h2>
                        <p class="text-text-secondary text-sm">Reference your analyzed report during the conversation</p>
                    </div>

                    <!-- Report Summary Card -->
                    <div class="medical-card mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-text-primary">Blood Test Results</h3>
                            <span class="text-xs text-text-secondary">July 20, 2025</span>
                        </div>
                        
                        <!-- Key Findings -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-text-secondary">Cholesterol</span>
                                <span class="text-sm font-medium status-warning px-2 py-1 rounded-lg">High (240 mg/dL)</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-text-secondary">Blood Sugar</span>
                                <span class="text-sm font-medium status-normal px-2 py-1 rounded-lg">Normal (95 mg/dL)</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-text-secondary">Hemoglobin</span>
                                <span class="text-sm font-medium status-error px-2 py-1 rounded-lg">Low (11.2 g/dL)</span>
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-surface-700">
                            <p class="text-xs text-text-secondary">
                                Your report shows elevated cholesterol and low hemoglobin levels that may require attention.
                            </p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="space-y-2">
                        <button class="w-full text-left text-sm text-primary hover:text-primary-400 transition-colors duration-200 p-2 rounded-lg hover:bg-primary/5" onclick="insertQuickQuestion('What does high cholesterol mean?')">
                            💡 What does high cholesterol mean?
                        </button>
                        <button class="w-full text-left text-sm text-primary hover:text-primary-400 transition-colors duration-200 p-2 rounded-lg hover:bg-primary/5" onclick="insertQuickQuestion('How can I improve my hemoglobin levels?')">
                            💡 How can I improve my hemoglobin levels?
                        </button>
                        <button class="w-full text-left text-sm text-primary hover:text-primary-400 transition-colors duration-200 p-2 rounded-lg hover:bg-primary/5" onclick="insertQuickQuestion('Should I be concerned about these results?')">
                            💡 Should I be concerned about these results?
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 flex flex-col">
                <!-- Mobile Report Summary Toggle -->
                <div class="lg:hidden border-b border-surface-700 bg-surface/50">
                    <button id="mobile-summary-toggle" class="w-full p-4 text-left flex items-center justify-between text-text-primary hover:bg-surface-700 transition-colors duration-200" onclick="toggleMobileSummary()">
                        <div>
                            <h3 class="font-medium">Blood Test Results</h3>
                            <p class="text-sm text-text-secondary">Tap to view report summary</p>
                        </div>
                        <svg id="summary-chevron" class="w-5 h-5 text-text-secondary transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>

                    <!-- Mobile Summary Panel -->
                    <div id="mobile-summary" class="hidden bg-surface border-t border-surface-700 p-4">
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-text-secondary">Cholesterol</span>
                                <span class="text-sm font-medium status-warning px-2 py-1 rounded-lg">High (240 mg/dL)</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-text-secondary">Blood Sugar</span>
                                <span class="text-sm font-medium status-normal px-2 py-1 rounded-lg">Normal (95 mg/dL)</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-text-secondary">Hemoglobin</span>
                                <span class="text-sm font-medium status-error px-2 py-1 rounded-lg">Low (11.2 g/dL)</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-2">
                            <button class="text-left text-sm text-primary hover:text-primary-400 transition-colors duration-200 p-2 rounded-lg hover:bg-primary/5" onclick="insertQuickQuestion('What does high cholesterol mean?')">
                                💡 What does high cholesterol mean?
                            </button>
                            <button class="text-left text-sm text-primary hover:text-primary-400 transition-colors duration-200 p-2 rounded-lg hover:bg-primary/5" onclick="insertQuickQuestion('How can I improve my hemoglobin levels?')">
                                💡 How can I improve my hemoglobin levels?
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chat Header -->
                <div class="border-b border-surface-700 bg-surface/30 p-4">
                    <div class="flex items-center space-x-3">
                        <!-- AI Avatar -->
                        <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-medium text-text-primary">Medical AI Assistant</h3>
                            <p class="text-sm text-text-secondary">Ask me anything about your report</p>
                        </div>
                        <div class="ml-auto">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-success rounded-full"></div>
                                <span class="text-xs text-text-secondary">Online</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Welcome Message -->
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                        <div class="chat-bubble chat-bubble-ai max-w-md">
                            <p class="text-text-primary text-sm leading-relaxed">
                                Hello! I've analyzed your blood test results. I can help explain your findings, answer questions about specific values, or discuss next steps. What would you like to know?
                            </p>
                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-primary/10">
                                <span class="text-xs text-text-secondary">11:48 AM</span>
                                <div class="flex items-center space-x-1">
                                    <div class="w-1 h-1 bg-success rounded-full"></div>
                                    <span class="text-xs text-success">High confidence</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sample User Message -->
                    <div class="flex items-start space-x-3 justify-end">
                        <div class="chat-bubble bg-primary/10 border-primary/20 max-w-md">
                            <p class="text-text-primary text-sm leading-relaxed">
                                What does my high cholesterol level mean? Should I be worried?
                            </p>
                            <div class="flex items-center justify-end mt-3 pt-3 border-t border-primary/10">
                                <span class="text-xs text-text-secondary">11:49 AM</span>
                            </div>
                        </div>
                        <div class="w-8 h-8 bg-surface-700 rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-sm font-medium text-text-primary">You</span>
                        </div>
                    </div>

                    <!-- Sample AI Response -->
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                        <div class="chat-bubble chat-bubble-ai max-w-md">
                            <div class="markdown-content text-text-primary text-sm leading-relaxed">
                                Your cholesterol level of **240 mg/dL** is considered high (above 200 mg/dL). Here's what this means:
                            </div>
                            <div class="bg-surface-700 rounded-lg p-3 mb-3">
                                <div class="text-xs text-text-secondary mb-2">CHOLESTEROL RANGES</div>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-success">Desirable:</span>
                                        <span class="text-text-primary">Less than 200 mg/dL</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-warning">Borderline:</span>
                                        <span class="text-text-primary">200-239 mg/dL</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-error">High:</span>
                                        <span class="text-text-primary font-medium">240+ mg/dL (Your level)</span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-text-primary text-sm leading-relaxed">
                                While this requires attention, it's manageable through diet, exercise, and possibly medication. I recommend discussing this with your doctor for a personalized treatment plan.
                            </p>
                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-primary/10">
                                <span class="text-xs text-text-secondary">11:50 AM</span>
                                <div class="flex items-center space-x-1">
                                    <div class="w-1 h-1 bg-success rounded-full"></div>
                                    <span class="text-xs text-success">High confidence</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Typing Indicator (Hidden by default) -->
                    <div id="typing-indicator" class="hidden flex items-start space-x-3">
                        <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                        <div class="chat-bubble chat-bubble-ai">
                            <div class="flex items-center space-x-2">
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-primary rounded-full animate-bounce"></div>
                                    <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                    <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                </div>
                                <span class="text-text-secondary text-sm">AI is thinking...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="border-t border-surface-700 bg-surface/30 p-4">
                    <form id="chat-form" class="flex items-end space-x-3">
                        <div class="flex-1">
                            <textarea id="message-input" rows="1" class="medical-input w-full resize-none min-h-[44px] max-h-32" placeholder="Ask about your report..." onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
                        </div>
                        <button type="submit" id="send-button" class="medical-button-primary px-4 py-3 min-w-[44px] h-[44px] flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <svg id="send-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                            <svg id="loading-icon" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                            </svg>
                        </button>
                    </form>

                    <!-- Quick Suggestions (Mobile) -->
                    <div class="lg:hidden mt-3 flex flex-wrap gap-2">
                        <button class="text-xs bg-surface-700 hover:bg-surface-600 text-text-secondary hover:text-text-primary px-3 py-2 rounded-full transition-colors duration-200" onclick="insertQuickQuestion('What does high cholesterol mean?')">
                            What does high cholesterol mean?
                        </button>
                        <button class="text-xs bg-surface-700 hover:bg-surface-600 text-text-secondary hover:text-text-primary px-3 py-2 rounded-full transition-colors duration-200" onclick="insertQuickQuestion('How can I improve my hemoglobin?')">
                            How can I improve my hemoglobin?
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isTyping = false;

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        // Mobile summary toggle
        function toggleMobileSummary() {
            const summary = document.getElementById('mobile-summary');
            const chevron = document.getElementById('summary-chevron');
            
            summary.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
            
            // Enable/disable send button
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = !textarea.value.trim();
        }

        // Handle keyboard shortcuts
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (!isTyping && event.target.value.trim()) {
                    sendMessage();
                }
            }
        }

        // Insert quick question
        function insertQuickQuestion(question) {
            const messageInput = document.getElementById('message-input');
            messageInput.value = question;
            autoResize(messageInput);
            messageInput.focus();
        }

        // Send message
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message || isTyping) return;

            // Add user message to chat
            addUserMessage(message);
            
            // Clear input
            messageInput.value = '';
            autoResize(messageInput);
            
            // Show typing indicator
            showTypingIndicator();
            
            // Simulate AI response
            setTimeout(() => {
                hideTypingIndicator();
                addAIResponse(generateAIResponse(message));
            }, 2000 + Math.random() * 2000);
        }

        // Add user message to chat
        function addUserMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3 justify-end';
            messageDiv.innerHTML = `
                <div class="chat-bubble bg-primary/10 border-primary/20 max-w-md">
                    <p class="text-text-primary text-sm leading-relaxed">${escapeHtml(message)}</p>
                    <div class="flex items-center justify-end mt-3 pt-3 border-t border-primary/10">
                        <span class="text-xs text-text-secondary">${currentTime}</span>
                    </div>
                </div>
                <div class="w-8 h-8 bg-surface-700 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-sm font-medium text-text-primary">You</span>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Add AI response to chat
        function addAIResponse(response) {
            const chatMessages = document.getElementById('chat-messages');
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3';
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                </div>
                <div class="chat-bubble chat-bubble-ai max-w-md">
                    <div class="markdown-content text-text-primary text-sm leading-relaxed">${parseMarkdown(response)}</div>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-primary/10">
                        <span class="text-xs text-text-secondary">${currentTime}</span>
                        <div class="flex items-center space-x-1">
                            <div class="w-1 h-1 bg-success rounded-full"></div>
                            <span class="text-xs text-success">High confidence</span>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Parse markdown text to HTML
        function parseMarkdown(text) {
            if (!text) return '';
            
            // Escape HTML first for security
            let html = escapeHtml(text);
            
            // Parse code blocks first (to avoid interfering with other parsing)
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre class="bg-surface-700 rounded-lg p-3 my-2 overflow-x-auto"><code class="font-data text-sm text-text-primary">$2</code></pre>');
            html = html.replace(/`([^`]+)`/g, '<code class="bg-surface-700 px-2 py-1 rounded text-sm font-data text-primary">$1</code>');
            
            // Parse headers
            html = html.replace(/^### (.*$)/gm, '<h3 class="text-lg font-semibold text-text-primary mt-4 mb-2">$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2 class="text-xl font-semibold text-text-primary mt-4 mb-2">$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold text-text-primary mt-4 mb-2">$1</h1>');
            
            // Parse bold and italic
            html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong class="font-bold text-text-primary"><em class="italic">$1</em></strong>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-text-primary">$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em class="italic text-text-primary">$1</em>');
            
            // Parse strikethrough
            html = html.replace(/~~(.*?)~~/g, '<del class="line-through text-text-secondary">$1</del>');
            
            // Parse links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-primary hover:text-primary-400 underline transition-colors duration-200" target="_blank" rel="noopener noreferrer">$1</a>');
            
            // Parse unordered lists
            html = html.replace(/^\* (.*$)/gm, '<li class="ml-4 mb-1 relative before:content-["•"] before:absolute before:-left-4 before:text-primary">$1</li>');
            html = html.replace(/^- (.*$)/gm, '<li class="ml-4 mb-1 relative before:content-["•"] before:absolute before:-left-4 before:text-primary">$1</li>');
            
            // Parse ordered lists
            let listCounter = 1;
            html = html.replace(/^\d+\. (.*$)/gm, function(match, content) {
                return `<li class="ml-6 mb-1 relative before:content-['${listCounter++}.'] before:absolute before:-left-6 before:text-primary before:font-medium">${content}</li>`;
            });
            
            // Wrap consecutive list items in ul/ol tags
            html = html.replace(/((?:<li class="ml-4[^>]*>.*?<\/li>\s*)+)/g, '<ul class="my-2 space-y-1">$1</ul>');
            html = html.replace(/((?:<li class="ml-6[^>]*>.*?<\/li>\s*)+)/g, '<ol class="my-2 space-y-1">$1</ol>');
            
            // Parse blockquotes
            html = html.replace(/^> (.*$)/gm, '<blockquote class="border-l-4 border-primary pl-4 py-2 my-2 bg-primary/5 rounded-r-lg"><p class="text-text-secondary italic">$1</p></blockquote>');
            
            // Parse horizontal rules
            html = html.replace(/^---$/gm, '<hr class="border-surface-600 my-4">');
            
            // Parse line breaks (double space or double newline)
            html = html.replace(/  \n/g, '<br>');
            html = html.replace(/\n\n/g, '</p><p class="mb-2">');
            
            // Wrap in paragraph if not already wrapped
            if (!html.startsWith('<')) {
                html = '<p class="mb-2">' + html + '</p>';
            }
            
            return html;
        }

        // Show typing indicator
        function showTypingIndicator() {
            isTyping = true;
            const typingIndicator = document.getElementById('typing-indicator');
            const sendButton = document.getElementById('send-button');
            const sendIcon = document.getElementById('send-icon');
            const loadingIcon = document.getElementById('loading-icon');
            
            typingIndicator.classList.remove('hidden');
            sendButton.disabled = true;
            sendIcon.classList.add('hidden');
            loadingIcon.classList.remove('hidden');
            
            scrollToBottom();
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            isTyping = false;
            const typingIndicator = document.getElementById('typing-indicator');
            const sendButton = document.getElementById('send-button');
            const sendIcon = document.getElementById('send-icon');
            const loadingIcon = document.getElementById('loading-icon');
            const messageInput = document.getElementById('message-input');
            
            typingIndicator.classList.add('hidden');
            sendButton.disabled = !messageInput.value.trim();
            sendIcon.classList.remove('hidden');
            loadingIcon.classList.add('hidden');
        }

        // Generate AI response (mock)
        function generateAIResponse(userMessage) {
            const responses = {
                'hemoglobin': `**Low hemoglobin** (11.2 g/dL) indicates mild anemia. This can be improved through:

* **Iron-rich foods** like spinach, lean meats, and beans
* **Vitamin C** sources to enhance iron absorption
* Consider discussing \`iron supplements\` with your doctor

> **Important**: Regular monitoring is recommended to track improvement.`,
                
                'cholesterol': `## High Cholesterol Management

Your cholesterol level of **240 mg/dL** is elevated and can be managed through:

1. **Dietary changes** - reducing saturated fats
2. **Regular exercise** - at least 30 minutes daily  
3. **Weight management** - maintaining healthy BMI
4. **Medication** - if lifestyle changes aren't sufficient

\`\`\`
Target Cholesterol: < 200 mg/dL
Current Level: 240 mg/dL
Reduction Needed: 40+ mg/dL
\`\`\``,
                
                'diet': `### Heart-Healthy Diet Recommendations

For your current results, focus on:

* **Increase fiber intake** - oats, beans, fruits
* **Choose lean proteins** - fish, poultry, legumes  
* **Limit processed foods** - reduce sodium and trans fats
* **Include omega-3 rich fish** - salmon, mackerel, sardines

This approach can help with **both cholesterol and hemoglobin levels**.`,
                
                'exercise': `## Exercise Recommendations

**Regular aerobic exercise** can significantly improve your health:

- **Duration**: 30 minutes, 5 days per week
- **Types**: Walking, swimming, cycling, dancing
- **Benefits**: Lower cholesterol, improved cardiovascular health
- **Getting started**: Begin gradually and build intensity

> **Note**: Consult your doctor before beginning any new exercise program.`,
                
                'medication': `### Medication Considerations

Based on your **cholesterol level of 240 mg/dL**, your doctor may consider:

1. **Statin medications** - most common cholesterol-lowering drugs
2. **Lifestyle modifications** - diet and exercise (first-line)
3. **Combination therapy** - if single approach insufficient

The decision depends on your:
* Overall cardiovascular risk factors
* Family history
* Other health conditions

*Always discuss with your healthcare provider.*`,
                
                'concerned': `## Managing Your Health Concerns

While these results need attention, they're **manageable with proper care**:

### ✅ Positive Aspects:
* High cholesterol and low hemoglobin are **common conditions**
* Both respond **well to treatment**
* Early detection allows for **proactive management**

### 📋 Next Steps:
* Schedule follow-up with healthcare provider
* Discuss treatment options
* Create action plan for improvement

You're taking the right steps by staying informed! 💪`,
                
                'normal': `### Excellent Blood Sugar Results! 🎉

Your **blood sugar level of 95 mg/dL** is excellent:

* **Normal range**: 70-99 mg/dL ✅
* **Your level**: 95 mg/dL ✅
* **Status**: Optimal glucose metabolism

This indicates:
- Good diabetes risk management
- Healthy metabolic function
- Effective glucose processing

Keep up the great work with your current lifestyle! 👍`
            };

            const lowerMessage = userMessage.toLowerCase();
            
            for (const [key, response] of Object.entries(responses)) {
                if (lowerMessage.includes(key)) {
                    return response;
                }
            }
            
            return `I understand your concern about your test results. Could you be **more specific** about which values you'd like me to explain? 

I can provide detailed information about:
* **Cholesterol levels** and management
* **Hemoglobin levels** and anemia  
* **Blood sugar** readings
* **General health recommendations**

Feel free to ask about any specific aspect! 🩺`;
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Form submission
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            scrollToBottom();
            document.getElementById('message-input').focus();
        });
    </script>
</body>
</html>